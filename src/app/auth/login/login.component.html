import React from 'react';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import '@testing-library/jest-dom';
import ContactUsSearch from './ContactUsSearch';
import { BrandDataProps } from '@iag-common/iag-brand-context';

// Mock the required contexts and functions
jest.mock('@iag-common/iag-brand-context', () => ({
  connectIagBrand: () => (Component: React.ComponentType) => Component,
}));

jest.mock('@iag-common/mfe-global-events-context', () => ({
  GlobalEventsContext: React.createContext(null),
}));

const mockSetData = jest.fn();
const mockSetSearchTerm = jest.fn();
const mockSetResultSectionVisible = jest.fn();
const mockSetNoResultSectionVisible = jest.fn();

const defaultProps: BrandDataProps & {
  setData: jest.Mock;
  searchTerm: string;
  setSearchTerm: jest.Mock;
  setresultSectionVisible: jest.Mock;
  setNoResultSectionVisible: jest.Mock;
} = {
  tt: jest.fn((key) => key), // Mock translation function
  setData: mockSetData,
  searchTerm: '',
  setSearchTerm: mockSetSearchTerm,
  setresultSectionVisible: mockSetResultSectionVisible,
  setNoResultSectionVisible: mockSetNoResultSectionVisible,
};

describe('ContactUsSearch component', () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  test('renders ContactUsSearch component', () => {
    render(<ContactUsSearch {...defaultProps} />);
    expect(screen.getByTestId('contact-us-search-btn')).toBeInTheDocument();
    expect(screen.getByPlaceholderText('pages.contactUsUplift.info.contactUsSearchInputPlaceholder')).toBeInTheDocument();
  });

  test('updates search term on input change', () => {
    render(<ContactUsSearch {...defaultProps} />);
    const input = screen.getByPlaceholderText('pages.contactUsUplift.info.contactUsSearchInputPlaceholder');
    fireEvent.change(input, { target: { value: 'payment' } });
    expect(mockSetSearchTerm).toHaveBeenCalledWith('payment');
  });

  test('filters data correctly when search button is clicked', async () => {
    const mockTt = jest.fn().mockImplementation((key) => {
      if (key === 'pages.contactUsUplift.categories') {
        return {
          'Category 1': [
            { question: 'How do I make a payment?', answer: 'You can make a payment online.' },
            { question: 'What is the refund policy?', answer: 'Refunds are processed within 7 days.' },
          ],
          'Category 2': [
            { question: 'How do I contact support?', answer: 'You can contact support via email or phone.' },
          ],
        };
      }
      return key;
    });

    render(<ContactUsSearch {...defaultProps} tt={mockTt} searchTerm="payment" />);
    
    const searchButton = screen.getByTestId('contact-us-search-btn');
    fireEvent.click(searchButton);

    await waitFor(() => {
      expect(mockSetData).toHaveBeenCalledWith({
        'Category 1': [
          { question: 'How do I make a payment?', answer: 'You can make a payment online.' },
        ],
      });
    });

    expect(mockSetResultSectionVisible).toHaveBeenCalledWith(true);
    expect(mockSetNoResultSectionVisible).not.toHaveBeenCalled();
  });

  test('displays no results message when no matches are found', async () => {
    const mockTt = jest.fn().mockImplementation((key) => {
      if (key === 'pages.contactUsUplift.categories') {
        return {
          'Category 1': [
            { question: 'How do I make a payment?', answer: 'You can make a payment online.' },
          ],
        };
      }
      return key;
    });

    render(<ContactUsSearch {...defaultProps} tt={mockTt} searchTerm="nonexistent" />);
    
    const searchButton = screen.getByTestId('contact-us-search-btn');
    fireEvent.click(searchButton);

    await waitFor(() => {
      expect(mockSetData).toHaveBeenCalledWith({});
    });

    expect(mockSetNoResultSectionVisible).toHaveBeenCalledWith(true);
  });

  test('handles empty search term', () => {
    render(<ContactUsSearch {...defaultProps} searchTerm="" />);
    
    const searchButton = screen.getByTestId('contact-us-search-btn');
    fireEvent.click(searchButton);

    expect(mockSetResultSectionVisible).toHaveBeenCalledWith(false);
    expect(screen.getByText('pages.contactUsUplift.info.contactUsNoSearchTerm')).toBeInTheDocument();
  });
});
