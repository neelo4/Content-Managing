import React from 'react';
import { fireEvent, screen, waitFor } from '@testing-library/react';
import '@testing-library/jest-dom/extend-expect';
import ContactUsSearch from './ContactUsSearch';
import { render } from './customRender';
import { GlobalEventsContext } from '@iag-common/mfe-global-events-context';

// Existing imports and mocks...

describe('ContactUsSearch', () => {
  // Existing test cases...

  // New test cases

  it('renders the page banner with breadcrumb', () => {
    render(<ContactUsSearch {...defaultProps} />);
    
    expect(screen.getByText('pages.contactUs.title')).toBeInTheDocument();
  });

  it('renders the title and subtitle sections', () => {
    render(<ContactUsSearch {...defaultProps} />);
    
    expect(screen.getByText('pages.contactUsUplift.info.contactUsSearchTitle')).toBeInTheDocument();
    expect(screen.getByText('pages.contactUsUplift.info.contactUsSearchSubTitle')).toBeInTheDocument();
  });

  it('displays no search term message when search button is clicked with empty input', () => {
    render(<ContactUsSearch {...defaultProps} />);
    
    const searchButton = screen.getByTestId('contact-us-search-btn');
    fireEvent.click(searchButton);
    
    expect(screen.getByText('pages.contactUsUplift.info.contactUsNoSearchTerm')).toBeInTheDocument();
  });

  it('filters data correctly when search term matches a category', async () => {
    const mockFaqData = {
      category1: [{ question: 'Test Question', answer: 'Test Answer' }],
      category2: [{ question: 'Another Question', answer: 'Another Answer' }],
    };

    jest.spyOn(React, 'useContext').mockImplementation(() => ({
      tt: (key: string) => {
        if (key === 'pages.contactUsUplift.categories') {
          return mockFaqData;
        }
        return key;
      },
    }));

    render(<ContactUsSearch {...defaultProps} searchTerm="category1" />);
    
    const searchButton = screen.getByTestId('contact-us-search-btn');
    fireEvent.click(searchButton);
    
    await waitFor(() => {
      expect(mockSetData).toHaveBeenCalledWith(expect.objectContaining({
        category1: expect.any(Array),
      }));
      expect(mockSetData).toHaveBeenCalledWith(expect.not.objectContaining({
        category2: expect.any(Array),
      }));
    });
  });

  it('filters data correctly when search term matches a question', async () => {
    const mockFaqData = {
      category1: [{ question: 'Test Question', answer: 'Test Answer' }],
      category2: [{ question: 'Another Question', answer: 'Another Answer' }],
    };

    jest.spyOn(React, 'useContext').mockImplementation(() => ({
      tt: (key: string) => {
        if (key === 'pages.contactUsUplift.categories') {
          return mockFaqData;
        }
        return key;
      },
    }));

    render(<ContactUsSearch {...defaultProps} searchTerm="Another Question" />);
    
    const searchButton = screen.getByTestId('contact-us-search-btn');
    fireEvent.click(searchButton);
    
    await waitFor(() => {
      expect(mockSetData).toHaveBeenCalledWith(expect.objectContaining({
        category2: expect.arrayContaining([
          expect.objectContaining({ question: 'Another Question' })
        ]),
      }));
    });
  });

  it('handles search for CRODS customer', async () => {
    jest.spyOn(React, 'useContext').mockImplementation(() => ({
      tt: (key: string) => {
        if (key === 'pages.contactUsUplift.categories') {
          return {
            category1: [{ question: 'CRODS Question', answer1: 'CRODS Answer' }],
          };
        }
        return key;
      },
    }));

    const getCustomerCheck = require('../../utils/partyUtils').getCustomerCheck;
    getCustomerCheck.mockReturnValue(true);

    render(<ContactUsSearch {...defaultProps} searchTerm="CRODS" />);
    
    const searchButton = screen.getByTestId('contact-us-search-btn');
    fireEvent.click(searchButton);
    
    await waitFor(() => {
      expect(mockSetData).toHaveBeenCalledWith(expect.objectContaining({
        category1: expect.arrayContaining([
          expect.objectContaining({ question: 'CRODS Question' })
        ]),
      }));
    });
  });

  it('dispatches tracking event on search button click', () => {
    const dispatchTrackingEventToDocument = require('@iag-common/mfe-global-events').dispatchTrackingEventToDocument;

    render(<ContactUsSearch {...defaultProps} searchTerm="test" />);
    
    const searchButton = screen.getByTestId('contact-us-search-btn');
    fireEvent.click(searchButton);
    
    expect(dispatchTrackingEventToDocument).toHaveBeenCalledWith(
      expect.any(Object),
      expect.objectContaining({
        pageName: expect.any(String),
        interaction: 'CLICK',
        element: expect.objectContaining({
          name: 'SEARCH',
          type: 'BUTTON',
          value: 'test',
        }),
      })
    );
  });
});
