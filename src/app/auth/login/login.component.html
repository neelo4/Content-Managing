import { renderHook } from '@testing-library/react-hooks';
import { MockedProvider } from '@apollo/client/testing';
import { gql } from '@apollo/client';
import { useGetOnboardingAndEdocsDetails } from './useGetOnboardingAndEdocsDetails';
import { AppContext } from '../../AppContext';
import { useFeaturesConfig } from '../../features-config';
import useBrowserDetect from '../useBrowserDetect';
import { getActivePolicyStatus } from '../../models/PolicyStatus';
import React from 'react';
import { FeatureName } from '../../features-config';

// Mock dependencies
jest.mock('../../features-config');
jest.mock('../useBrowserDetect');
jest.mock('../../models/PolicyStatus');

const ONBOARDING_QUERY = gql`
  query getOnboardingAndEdocsStatus($policy_statuses: [String]) {
    getOnboardingAndEdocsStatus(policyStatuses: $policy_statuses)
  }
`;

describe('useGetOnboardingAndEdocsDetails', () => {
  it('should update app state when query completes with data', async () => {
    // Clear all mocks
    jest.clearAllMocks();
    
    // Set up feature flags to ensure query isn't skipped
    (useFeaturesConfig as jest.Mock).mockImplementation((featureName: FeatureName) => {
      if (featureName === FeatureName.SHOW_DOOTB_ONBOARDING) return true;
      if (featureName === FeatureName.SHOW_DOOTB_EDOCS_MODAL) return true;
      return false;
    });
    
    // Set up browser detection to not skip
    (useBrowserDetect as jest.Mock).mockReturnValue({ isMobileApp: false });
    
    // Set up policy status
    (getActivePolicyStatus as jest.Mock).mockReturnValue(['ACTIVE']);

    const mockSetAppState = jest.fn();
    
    const mockResponse = {
      getOnboardingAndEdocsStatus: {
        showOnboarding: true,
        showEdocs: false,
        policies: ['policy1', 'policy2'],
        someOtherField: 'value'
      }
    };

    const mocks = [
      {
        request: {
          query: ONBOARDING_QUERY,
          variables: { policy_statuses: ['ACTIVE'] }
        },
        result: {
          data: mockResponse
        }
      }
    ];

    const wrapper = ({ children }: { children: React.ReactNode }) => (
      <AppContext.Provider value={{ setAppState: mockSetAppState, appState: {} }}>
        <MockedProvider mocks={mocks} addTypename={false}>
          {children}
        </MockedProvider>
      </AppContext.Provider>
    );

    const { result, waitForNextUpdate } = renderHook(() => useGetOnboardingAndEdocsDetails(), { wrapper });

    // Initial state check
    expect(result.current.loading).toBe(true);

    // Wait for query to complete
    await waitForNextUpdate();

    // Verify the state updates
    const updateStateCalls = mockSetAppState.mock.calls;
    
    // First update should set the onboardingAndEdocsResult
    const firstUpdate = updateStateCalls[0][0]({});
    expect(firstUpdate).toEqual({
      onboardingAndEdocsResult: {
        showOnboarding: true,
        showEdocs: false,
        someOtherField: 'value'
      }
    });

    // Second update should set isOnboardingAndEdocsCallCompleted
    const secondUpdate = updateStateCalls[1][0]({});
    expect(secondUpdate).toEqual({
      isOnboardingAndEdocsCallCompleted: true
    });

    // Final state check
    expect(result.current.loading).toBe(false);
    expect(result.current.data).toEqual(mockResponse.getOnboardingAndEdocsStatus);
  });
});
